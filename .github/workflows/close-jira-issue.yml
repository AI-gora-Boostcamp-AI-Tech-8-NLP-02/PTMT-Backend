name: Close Jira issue
on:
  issues:
    types:
      - closed

jobs:
  close-issue:
    name: Close Jira issue
    runs-on: ubuntu-latest
    env:
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

    steps:
      - name: JIRA Login
        run: |
          curl --fail --request GET \
          --url "https://${JIRA_BASE_URL}/rest/api/3/myself" \
          --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
          --header "Accept: application/json"
    
      - name: Extract JIRA ticket number from GitHub issue title
        id: extract-key
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          JIRA_KEY=$(echo "$ISSUE_TITLE" | grep -oE '[A-Z]+-[0-9]+')
          echo "JIRA_KEY=$JIRA_KEY" >> $GITHUB_ENV

      - name: Close JIRA issue
        if: env.JIRA_KEY != ''
        run: |
          curl --fail --silent --request POST \
            --url "https://${JIRA_BASE_URL}/rest/api/3/issue/${{ env.JIRA_KEY }}/transitions" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json" \
            --header "Content-Type: application/json" \
            --data '{
              "transition": {
                "id": "31"
              }
            }'
